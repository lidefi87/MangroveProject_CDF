---
title: "Mangrove fish assemblages from the Galapagos Islands"
author: "Denisse Fierro Arcos"
date: '2020-03-03'
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

## Data analysis: Mangrove fish assemblages from the Galapagos Islands
Date of creation: 2018-04-30\
Date of latest update: 2020-03-03\
Version # 3
Prepared for the Sharks Ecology Project of the Charles Darwin Foundation (CDF).\
Related to work published in xxxx titled "First archipelago-wide characterisation and analysis of spatial distribution patterns of mangrove fish assemblages in the Galapagos, a UNESCO World Heritage Site".

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Uploading relevant libraries
```{r libraries, results = "hide", warning = F, message = F}
library(tidyverse)
library(vegan)
library(statsr)
library(patchwork)
library(ggpubr)
library(cowplot)
```

### Uploading general data to be used in the analysis
```{r}
#Fish database: includes information information such as max length, and trophic level
FishData <- read.csv("Data/FishDB.csv")

#List of non-fish species sampled by both sampling methods
NonFish = c("Cardisoma crassum", "Chelonia mydas", "Chelonia  mydas", "Cheloniidae sp", "Phalacrocorax harrisi", "Spheniscus mendiculus", "Scyllarides astori", "Zalophus wollebaeki")
```

### Underwater Visual Census (UVC) data
```{r}
#Count data
UVC <- read.csv("Data/UVC_Data.csv")

#UVC environmental data
UVCEnviro <- read.csv("Data/UVCEnviro.csv")
```

#### UVC Data transformation
```{r, warning = F}
#Filtering out non-fish species from UVC database and creating tibble table from UVC data frame containing counts
UVC <- UVC %>% tbl_df() %>% filter(!Species %in% NonFish) %>% 
  mutate(Species = factor(Species))

#Filtering out non-mangrove areas and creating a tibble table from UVC environmental data
UVCEnviro <- UVCEnviro %>% filter(Habitat == "Mangrove") %>% tbl_df()

#Creating new tibble table containing counts data per site and per species
CountsUVC <- UVC %>% 
  right_join(., select(UVCEnviro, SiteName), by = "SiteName") %>%
  mutate(SiteCode = factor(SiteCode), Species = factor(Species)) %>% 
  group_by(Bioregion, Island, SiteCode, Replicate, Species) %>% 
  summarise_at(vars(Counts), funs(N = sum(., na.rm = T))) %>% 
  group_by(Bioregion, SiteCode, Species) %>% 
  summarise_at(vars(N), funs(MeanN = mean(., na.rm = T))) %>% 
  complete(Species, nesting(Bioregion, SiteCode)) %>% 
  rename(SiteName = SiteCode)
head(CountsUVC, n = 5)

#Checking species are correctly named as per FishData and attaching Family and Genus data
CountsUVC <- FishData %>% select(Family, Genus, ScientificName, ValidName, TrophicCat) %>% 
  rename("Species"="ScientificName") %>% 
  left_join(CountsUVC, ., by = "Species") %>% 
  select(-Species) %>% 
  rename("Species"="ValidName") %>% 
  mutate(Species = factor(Species)) %>% 
  ungroup()
```

### Baited Remote Underwater Video (BRUV) data
```{r}
#MaxN data
BRUV <- read.csv("Data/BRUVSMaxN.csv")
#Environmental data
BRUVEnviro <- read.csv("Data/BRUVEnviro.csv")
```

#### BRUV Data transformation
```{r, warning = F}
#Filtering out non-fish species from BRUV database, removing MaxN for different life stages/sex (MaxN column will conserve actual MaxN observed) and creating tibble table from BRUV data frame containing counts
BRUV <- BRUV %>% tbl_df() %>%
  filter(!SpeciesName %in% NonFish) %>% 
  filter(.,!duplicated(select(.,SiteName, Family, Genus, SpeciesName)))%>% 
  mutate(SpeciesName = factor(SpeciesName))

#Filtering out non-mangrove areas and creating a tibble table from BRUV environmental data
BRUVEnviro <- BRUVEnviro %>% filter(Habitat == "Mangrove") %>% tbl_df()

#Creating new tibble table containing counts data per site and per species
CountsBRUV <- BRUV %>% select(-c(Species, Stage, MaxN.by.stage)) %>% 
  right_join(., select(BRUVEnviro, SiteName, Bioregion, Island), by = "SiteName") %>%
  mutate(SiteCode = factor(SiteCode), SpeciesName = factor(SpeciesName),
         Replicate = factor(Replicate)) %>% 
  group_by(Bioregion, Island, SiteCode, Replicate, SpeciesName) %>% 
  summarise_at(vars(MaxN), funs(N = sum(., na.rm = T))) %>% 
  group_by(Bioregion, SiteCode, SpeciesName) %>% 
  summarise_at(vars(N), funs(MeanN = mean(., na.rm = T))) %>% 
  rename("Species"="SpeciesName", "SiteName"="SiteCode") %>% 
  complete(Species, nesting(Bioregion, SiteName)) 
head(CountsUVC, n = 5)

#Checking species are correctly named as per FishData and attaching Family and Genus data
CountsBRUV <- FishData %>% select(Family, Genus, ScientificName, ValidName, TrophicCat) %>% 
  rename("Species"="ScientificName") %>% 
  left_join(CountsBRUV, ., by = "Species") %>% 
  select(-Species) %>% 
  rename("Species"="ValidName") %>% 
  mutate(Species = factor(Species)) %>% 
  ungroup()
```

### Fish communities statistics both methods
```{r, Fish communities}
#Creating dataset containing information for both methods
CountsALL <- rbind(CountsBRUV %>% mutate(Method = "BRUV"), 
                   CountsUVC %>% mutate(Method = "UVC"))
```

#### Families
```{r Families}
#Families both methods - Removing silvery fish
CountsALL %>% filter(!grepl("^Silvery*", Family)) %>% distinct_at(vars(Family)) %>% nrow() %>% 
  paste0("Families: ", .)

#Families per method and per bioregion
CountsALL %>% filter(!grepl("^Silvery*", Family)) %>% 
  filter(!is.na(MeanN)) %>% group_by(Bioregion, Method) %>%
  distinct_at(vars(Family)) %>% summarise_at(vars(Family), funs(Fam = n()))

#Families per method
CountsALL %>% filter(!grepl("^Silvery*", Family)) %>% 
  filter(!is.na(MeanN)) %>% group_by(Method) %>%
  distinct_at(vars(Family)) %>% summarise_at(vars(Family), funs(Fam = n()))

#Families per bioregion
CountsALL %>% filter(!grepl("^Silvery*", Family)) %>% 
  filter(!is.na(MeanN)) %>% group_by(Bioregion) %>%
  distinct_at(vars(Family)) %>% summarise_at(vars(Family), funs(Fam = n()))

#List of Families unique to UVC: 
CountsUVC %>% distinct_at(vars(Family))%>% 
  anti_join(distinct_at(CountsBRUV, vars(Family))) %>% 
  distinct() %>% drop_na()

#List of Families unique to UVC per bioregion:
CountsUVC %>% 
  filter(!is.na(MeanN)) %>% group_by(Bioregion) %>%
  distinct_at(vars(Family)) %>% 
  anti_join(distinct_at(CountsBRUV %>% filter(!is.na(MeanN)) %>% group_by(Bioregion), vars(Family)))
  
#List of Families unique to BRUV: 
CountsBRUV %>% distinct_at(vars(Family))%>% 
  filter(!grepl("^Silvery*", Family)) %>% 
  anti_join(distinct_at(CountsUVC, vars(Family))) %>% 
  distinct() %>% drop_na()

#List of Families unique to BRUV per bioregion:
CountsBRUV %>% filter(!grepl("^Silvery*", Family)) %>% 
  filter(!is.na(MeanN)) %>% group_by(Bioregion) %>%
  distinct_at(vars(Family)) %>% 
  anti_join(distinct_at(CountsUVC %>% filter(!is.na(MeanN)) %>% group_by(Bioregion), vars(Family)))
```

#### Genus
```{r Genus}
#Genus both methods
CountsALL %>% 
  distinct_at(vars(Genus)) %>% nrow() %>% paste0("Genus: ", .)

#Genus per method and per bioregion
CountsALL %>% 
  filter(!is.na(MeanN)) %>% group_by(Bioregion, Method) %>%
  distinct_at(vars(Genus)) %>% summarise_at(vars(Genus), funs(Gen = n()))

#Genus per method
CountsALL %>% 
  filter(!is.na(MeanN)) %>% group_by(Method) %>%
  distinct_at(vars(Genus)) %>% summarise_at(vars(Genus), funs(Gen = n()))

#Genus per bioregion
CountsALL %>% 
  filter(!is.na(MeanN)) %>% group_by(Bioregion) %>%
  distinct_at(vars(Genus)) %>% summarise_at(vars(Genus), funs(Gen = n()))
```

#### Species
```{r Species}
#Species both methods
CountsALL %>% 
  filter(!grepl("* sp$",Species)) %>% distinct_at(vars(Species)) %>% nrow() %>% paste0("Species: ", .)

#Species per method and per bioregion
CountsALL %>% filter(!grepl("* sp$", Species)) %>% 
  filter(!is.na(MeanN)) %>% group_by(Bioregion, Method) %>%
  distinct_at(vars(Species)) %>% summarise_at(vars(Species), funs(Spec = n()))

#Species per method
CountsALL %>% filter(!grepl("* sp$", Species)) %>% 
  filter(!is.na(MeanN)) %>% group_by(Method) %>%
  distinct_at(vars(Species)) %>% summarise_at(vars(Species), funs(Spec = n()))

#Species per bioregion
CountsALL %>% filter(!grepl("* sp$", Species)) %>% 
  filter(!is.na(MeanN)) %>% group_by(Bioregion) %>%
  distinct_at(vars(Species)) %>% summarise_at(vars(Species), funs(Spec = n()))

#List of Species unique to UVC: 
CountsUVC %>% filter(!grepl("* sp$",Species)) %>% 
  distinct_at(vars(Species))%>%  
  anti_join(distinct_at(CountsBRUV, vars(Species))) %>% 
  distinct() %>% drop_na()

#List of Species unique to UVC per bioregion:
CountsUVC %>% filter(!grepl("* sp$",Species)) %>% 
  filter(!is.na(MeanN)) %>% group_by(Bioregion) %>%
  distinct_at(vars(Species)) %>% 
  anti_join(distinct_at(CountsBRUV %>% filter(!is.na(MeanN)) %>% group_by(Bioregion), vars(Species))) %>% 
  summarise_at(vars(Species), funs(Spec = n()))

#List of Species unique to BRUV: 
CountsBRUV %>% filter(!grepl("* sp$",Species)) %>% 
  distinct_at(vars(Species))%>%  
  anti_join(distinct_at(CountsUVC, vars(Species))) %>% 
  distinct() %>% drop_na()

#List of Species unique to BRUV per bioregion:
CountsBRUV %>% filter(!grepl("* sp$",Species)) %>% 
  filter(!is.na(MeanN)) %>% group_by(Bioregion) %>%
  distinct_at(vars(Species)) %>% 
  anti_join(distinct_at(CountsUVC %>% filter(!is.na(MeanN)) %>% group_by(Bioregion), vars(Species))) %>% 
  summarise_at(vars(Species), funs(Spec = n()))
```

#### Individuals
```{r individuals}
#Individual Fish
BRUV %>% select(-c(Species, Stage, MaxN.by.stage)) %>% 
  right_join(., select(BRUVEnviro, SiteName, Bioregion, Island), by = "SiteName") %>% 
  summarise(Tot = sum(MaxN)) + UVC %>% 
  mutate(SiteCode = factor(SiteCode)) %>% 
  right_join(., select(UVCEnviro, SiteName), by = "SiteName") %>% 
  summarise(Tot = sum(Counts)) 

#Individuals per method and per bioregion
#BRUVS
BRUV %>% select(-c(Species, Stage, MaxN.by.stage)) %>% 
  right_join(., select(BRUVEnviro, SiteName, Bioregion, Island), by = "SiteName") %>% 
  group_by(Bioregion) %>% summarise(Tot = sum(MaxN))
#UVC
UVC %>% 
  mutate(SiteCode = factor(SiteCode)) %>% 
  right_join(., select(UVCEnviro, SiteName), by = "SiteName") %>% 
  group_by(Bioregion)%>% summarise(Tot = sum(Counts)) 
```

#### Number of fish classified as Silvery Fish
```{r Not Identified}
#Fish that could not be identified to species level (Silvery Fish)
CountsBRUV %>% filter(grepl("*silvery*", Species)) %>% summarise_if(is.numeric, sum, na.rm = T)
```

### Biodiversity measures
```{r, Biodiversity measures}
#Constructing matrix for multivariate analysis
FM_ALL <- CountsALL %>% 
  mutate(SiteName = paste(SiteName, str_sub(Method, end = 1), sep = "_")) %>% 
  select(SiteName, Species, MeanN) %>% 
  pivot_wider(names_from = Species, values_from = MeanN) %>% 
  remove_rownames() %>% 
  column_to_rownames(var = "SiteName") %>% as.matrix() %>% replace_na(., 0) %>% 
  .[order(rownames(.)),]
head(FM_ALL[,1:3])

#Creating new matrix with adjusted abundance values
Norm_FMALL <- prop.table(FM_ALL, 1)
head(Norm_FMALL[,1:3])

#Creating database of biodiversity measures
BioAll <- tibble(SiteName = str_sub(row.names(FM_ALL), end = -3),
                 Method = str_sub(row.names(FM_ALL), start = -1),
                 SpRich = specnumber(FM_ALL),
                 N = rowSums(FM_ALL),
                 Shannon = round(diversity(FM_ALL), 3),
                 Pielou = round(Shannon/log(N), 3)) %>% 
  mutate(Method = replace(Method, Method =="B", "BRUV")) %>% 
  mutate(Method = replace(Method, Method =="U", "UVC")) %>% 
  left_join(select(CountsALL, Bioregion, SiteName, Method) %>% unique(), ., by = c("SiteName", "Method"))
```

#### Plotting mean abundance
```{r mean abundance}
#Number of individuals
p1 <- ggplot(BioAll, aes(Method, N))+geom_boxplot()+
  labs(y = "Mean abundance")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 12), 
        axis.text = element_text(family = "sans", size = 12))
p2 <- ggplot(BioAll, aes(Bioregion, N))+geom_boxplot()+facet_grid(.~Method)+
  labs(y = "Mean abundance")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 12), 
        axis.text = element_text(family = "sans", size = 12))
MeanAbund <- ggarrange(p1, p2, nrow = 2, labels = c("A", "B"))
MeanAbund
rm(p1, p2)
ggsave("Figures/MeanAbundance.tiff", MeanAbund, device = "tiff", dpi = 400)

#Testing for differences between methods and bioregions - Univariate PERMANOVA
adonis(N ~ Bioregion*Method, data = BioAll, method = "euc", permutations = 9999)
```

#### Plotting species richness
```{r species richness plot}
#Species richness
p1 <- ggplot(BioAll, aes(Method, SpRich))+geom_boxplot()+
  labs(y = "Species richness")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 14), 
        axis.text = element_text(family = "sans", size = 12))
p2 <- ggplot(BioAll, aes(Bioregion, SpRich))+geom_boxplot()+
  facet_grid(~Method)+labs(y = "Species richness")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 14), 
        axis.text = element_text(family = "sans", size = 12))
SpRich <- ggarrange(p1, p2, nrow = 2, labels = c("A", "B"))
SpRich
rm(p1, p2)
ggsave("Figures/SpeciesRichness.tiff", SpRich, device = "tiff", dpi = 400)

#Testing for differences between methods and bioregions - Univariate PERMANOVA
adonis(SpRich ~ Bioregion*Method, data = BioAll, method = "euc", permutations = 9999)
```

#### Plotting Shannon diversity index
```{r Shannon diversity}
#Species richness
p1 <- ggplot(BioAll, aes(Method, Shannon))+geom_boxplot()+
  labs(y = "Shannon-Wiener index")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 14), 
        axis.text = element_text(family = "sans", size = 12))
p2 <- ggplot(BioAll, aes(Bioregion, Shannon))+geom_boxplot()+
  facet_grid(~Method)+labs(y = "Shannon-Wiener index")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 14), 
        axis.text = element_text(family = "sans", size = 12))
ShannonInd <- ggarrange(p1, p2, nrow = 2, labels = c("A", "B"), vjust = 18)
ShannonInd
rm(p1, p2)
ggsave("Figures/ShannonIndex.tiff", ShannonInd, device = "tiff", dpi = 400)

#Testing for differences between methods and bioregions - Univariate PERMANOVA
adonis(Shannon ~ Bioregion*Method, data = BioAll, method = "euc", permutations = 9999)
```

#### Plotting Pielou evenness index
```{r Pielou evenness}
#Species evenness
p1 <- ggplot(BioAll, aes(Method, Pielou))+geom_boxplot()+
  labs(y = "Pielou's evenness index")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 14), 
        axis.text = element_text(family = "sans", size = 12))
p2 <- ggplot(BioAll, aes(Bioregion, Pielou))+geom_boxplot()+
  facet_grid(~Method)+labs(y = "Pielou's evenness index")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 14), 
        axis.text = element_text(family = "sans", size = 12))
Pielou <- ggarrange(p1, p2, nrow = 2, labels = c("A", "B"), vjust = 18)
Pielou
rm(p1, p2)
ggsave("Figures/Pielou.tiff", Pielou, device = "tiff", dpi = 400)

#Testing for differences between methods and bioregions - Univariate PERMANOVA
adonis(Pielou ~ Bioregion*Method, data = BioAll, method = "euc", permutations = 9999)
```

### Plotting fish community composition
```{r fish community by method}
#By method
Counts <- CountsALL %>% select(Method, Bioregion, Family, MeanN) %>% 
  group_by(Method) %>% 
  mutate(TotalAb = sum(MeanN, na.rm = T)) %>% 
  group_by(Method, Family) %>% 
  summarise(Sum = sum(MeanN, na.rm = T), 
            Mean = mean(MeanN, na.rm = T),
            SE = plotrix::std.error(MeanN, na.rm = T),
            TotalAb = mean(TotalAb, na.rm = T), 
            Prop = Sum/TotalAb) 
Counts %>% 
  group_by(Method) %>% 
  filter(Sum > 0) %>% 
  summarise_at(vars(Family), funs(N = n()))
```

```{r graph fish community by method}
#Graph
p1 <- Counts %>% filter(Prop > 0.05) %>% 
  ggplot(., aes(x = Method, y = Prop, fill = Family))+
  geom_bar(position = "stack", stat = "identity")+
  scale_fill_manual(values = c("#a6cee3", "#1f78b4", "#b2df8a", "#fb9a99", "#e31a1c", "#fdbf6f",
                               "#6a3d9a"))+
  # geom_errorbar(aes(x = Family, position = "dodge", ymin = Mean-SE, ymax = Mean+SE))+
  coord_flip()+
  scale_x_discrete(limits = rev(levels(as.factor(Counts$Method))))+
  labs(x = "Methods", y = "Proportion of total abundance")+
  theme_bw()+theme(axis.title.y = element_text(family = "sans", size = 10), 
                   axis.text = element_text(family = "sans", size = 10),
                   legend.text = element_text(family = "sans", size = 10),
                   legend.title = element_text(family = "sans", size = 10),
                   legend.position = "none",
                   axis.ticks.length.x = unit(0.25, "cm"))+
  annotate(geom = "text", x = 2, y = 0.7, label = "+30 families")+
  annotate(geom = "text", x = 1, y = 0.7, label = "+25 families")
p1
rm(Counts)
```

```{r fish community by method & bioregion}
##By method and bioregion
CountsBio <- CountsALL %>% select(Method, Bioregion, Family, MeanN) %>% 
  group_by(Method, Bioregion) %>% 
  mutate(TotalAb = sum(MeanN, na.rm = T)) %>% 
  group_by(Method, Bioregion, Family) %>% 
  summarise(Sum = sum(MeanN, na.rm = T), 
            Mean = mean(MeanN, na.rm = T),
            SE = plotrix::std.error(MeanN, na.rm = T),
            TotalAb = mean(TotalAb, na.rm = T), 
            Prop = Sum/TotalAb) 

CountsBio %>% group_by(Method, Bioregion) %>% 
  filter(Sum > 0) %>% summarise_at(vars(Family), funs(N = n()))
```

```{r graph fish community by method & bioregion}
#Creating data frame containing annotations about the number of families not shown in the graph. Based on summary information produced in the previous step
annot_text <- data.frame(Bioregion = c("CSE", "Western", "CSE", "Western"),
                         Method = c("BRUV", "BRUV", "UVC", "UVC"),
                         Label = c("+26 families", "+18 families",
                                   "+23 families", "+14 families"))

#Graph
p2 <- CountsBio %>% ungroup() %>% filter(Prop > 0.05) %>% 
  ggplot(., aes(x = "", y = Prop, fill = Family))+
  geom_bar(position = "stack", stat = "identity")+
  scale_fill_manual(values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f",
                               "#ff7f00", "#cab2d6", "#6a3d9a"),
                    guide = guide_legend(nrow = 3))+
  facet_grid(Method~Bioregion)+coord_flip()+
  theme(legend.position = "none")+
  geom_text(size = 4, family = "sans", data = annot_text, 
            mapping = aes(x = Inf, y = Inf, label = Label),
            inherit.aes = F,
            hjust = 1.05, vjust = 5)+
  labs(x = "", y = "Proportion of total abundance")+
  theme_bw()
p2

#Merging the two plots into one panel
p2leg <- get_legend(p2)
CommComp <- plot_grid(p1, p2+theme(legend.position = "none"), align = "hv", axis = "lb", labels = c("A", "B"), 
          hjust = -1.5, rel_widths = c(0.8, 1))
CommComp <- plot_grid(p2leg, CommComp, ncol = 1, rel_heights = c(0.2, 1))
CommComp
rm(p1, p2, annot_text, CountsBio, p2leg)
ggsave("Figures/CommunityFamComp.tiff", CommComp, device = "tiff", dpi = 400)
```

### Comparing carnivores and herbivores between methods 
```{r carnivores and herbivores}
#Creating dataframe with summary of trophic data - Blank category appears for individuals not identified to species level
Troph <- CountsALL %>% 
  group_by(Method, SiteName) %>% 
  mutate(TotalAb = sum(MeanN, na.rm = T)) %>% 
  group_by(Method, SiteName, TrophicCat) %>%
  mutate(TotTrop = sum(MeanN, na.rm = T), 
         PropTrop = TotTrop / TotalAb) %>% 
  group_by(Method, Bioregion, SiteName, TrophicCat) %>% 
  summarise_at(vars(PropTrop), funs(mean(., na.rm = T))) 

#Summary and graph at a method level
p1 <- Troph %>% group_by(Method, TrophicCat) %>% 
  summarise(MeanTrop = mean(PropTrop, na.rm = T), 
            SE_Trop = plotrix::std.error(PropTrop, na.rm = T)) %>% 
  filter(!TrophicCat == "") %>% 
  ggplot(aes(TrophicCat, MeanTrop))+geom_bar(stat = "identity", color = "black")+
  geom_errorbar(aes(ymin = MeanTrop, ymax = MeanTrop+SE_Trop), width = 0.2)+
  facet_wrap(~Method)+theme_bw()+
  labs(x = "", y = "Mean relative abundance")+
  theme(axis.title = element_text(family = "sans", size = 10), 
                   axis.text = element_text(family = "sans", size = 10))

#Summary and graph at a method and bioregion level
p2 <- Troph %>% group_by(Method, Bioregion, TrophicCat) %>% 
  summarise(MeanTrop = mean(PropTrop, na.rm = T), 
            SE_Trop = plotrix::std.error(PropTrop, na.rm = T)) %>% 
  filter(!TrophicCat == "") %>% 
  ggplot(aes(TrophicCat, MeanTrop, fill = Bioregion))+
  geom_bar(stat = "identity", color = "black", position = position_dodge())+
  geom_errorbar(aes(ymin = MeanTrop, ymax = MeanTrop+SE_Trop), width = 0.2, position = position_dodge(.9))+
  facet_wrap(~Method)+theme_bw()+
  labs(x = "", y = "Mean relative abundance")+
  theme(axis.title = element_text(family = "sans", size = 10), 
                   axis.text = element_text(family = "sans", size = 10),
        legend.position = "top")

TrophCat <- ggarrange(p1, p2, labels = c("A", "B"), nrow = 2, hjust = -1)
TrophCat
rm(p1, p2, Troph)
ggsave("Figures/TrophicProportions.tiff", TrophCat, device = "tiff", dpi = 400)
```

### Comparing fish assemblages between methods and bioregions
```{r fish assemblages}
AllEnviro <- plyr::rbind.fill(BRUVEnviro %>% 
                                select(-c(SiteName, Replicate, Depth, Facing.mangroves., Habitat)) %>%
                                mutate(SiteCode = paste0(SiteCode, "_B"), Method = "BRUV") %>% 
                                group_by(SiteCode, Bioregion, Island, Method) %>% 
                                summarise_if(is.numeric, mean), 
                              UVCEnviro %>% 
                                select(-c(SiteName, Depth, Habitat)) %>% 
                                mutate(SiteCode = paste0(SiteCode, "_U"), Method = "UVC") %>% 
                                group_by(SiteCode, Bioregion, Island, Method)%>% 
                                summarise_if(is.numeric, mean)) %>% arrange(SiteCode)

vare.dis <- vegdist(Norm_FMALL)
vare.mds0 <- MASS::isoMDS(vare.dis)
stressplot(vare.mds0, vare.dis)
ordiplot(vare.mds0, type = "t")
vare.mds <- metaMDS(Norm_FMALL, trace = F, trymax = 300)
vare.mds
plot(vare.mds, type = "t", display = "sites")
plot(vare.mds, type = "t", display = "species")

#Checking which similarity index best separates communities along known gradients using rank correlations
rankindex(scale(AllEnviro %>% select_if(is.numeric)),
          Norm_FMALL, c("euc", "man", "bray", "jac", "kul"))

dis <- vegdist(decostand(Norm_FMALL, "norm"), "euc")

vare.pca <- rda(Norm_FMALL, scale = T)

ef <- envfit(vare.mds, AllEnviro %>% select_if(is.numeric), permutations = 999, na.rm = T)
plot(vare.mds, display = "sites", type = "t")
plot(ef, p.max = 0.1)

ef <- envfit(vare.mds ~ WetTemp + WetChla, AllEnviro)

Mang.cca <- cca(Norm_FMALL ~ Method, AllEnviro)
anova(Mang.cca, by = "term")
ef <- envfit(Mang.cca ~ WetTemp + WetChla + perim100_m, AllEnviro)
ef
plot(Mang.cca, display = "sites", type = "t")
plot(ef)

```

