---
title: "Mangrove fish assemblages from the Galapagos Islands"
author: "Denisse Fierro Arcos"
date: '2020-03-03'
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

## Data analysis: Mangrove fish assemblages from the Galapagos Islands
Date of creation: 2018-04-30\
Date of latest update: 2020-03-03\
Version # 3
Prepared for the Sharks Ecology Project of the Charles Darwin Foundation (CDF).\
Related to work published in xxxx titled "First archipelago-wide characterisation and analysis of spatial distribution patterns of mangrove fish assemblages in the Galapagos, a UNESCO World Heritage Site".

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Uploading relevant libraries
```{r libraries, results = "hide", warning = F, message = F}
library(tidyverse)
library(vegan)
library(statsr)
library(patchwork)
library(ggpubr)
library(cowplot)
library(ggrepel)
```

### Calling Kernel Density Function developed by Langlois et al, 2012
```{r KD function}
source(file = "Modified_Langlois_etal_KDE.R")
```

### Uploading general data to be used in the analysis
```{r General data}
#Fish database: includes information information such as max length, and trophic level
FishData <- read.csv("Data/FishDB.csv")

#List of non-fish species sampled by both sampling methods
NonFish = c("Cardisoma crassum", "Chelonia mydas", "Chelonia  mydas", "Cheloniidae sp", "Phalacrocorax harrisi", "Spheniscus mendiculus", "Scyllarides astori", "Zalophus wollebaeki")
```

### Underwater Visual Census (UVC) data
```{r}
#Count data
UVC <- read.csv("Data/UVC_Data_AllPts.csv")

#UVC environmental data
UVCEnviro <- read.csv("Data/UVCEnviro_AllPts.csv")
```

#### UVC Data transformation
```{r, warning = F}
#Filtering out non-fish species from UVC database and creating tibble table from UVC data frame containing counts
UVC <- UVC %>% tbl_df() %>% filter(!Species %in% NonFish) %>% 
  mutate(Species = factor(Species))

#Filtering out non-mangrove areas and creating a tibble table from UVC environmental data
UVCEnviro <- UVCEnviro %>% filter(Habitat == "Mangrove") %>% tbl_df()

#Creating new tibble table containing counts data per site and per species
CountsUVC <- UVC %>% 
  right_join(., select(UVCEnviro, SiteCode), by = "SiteCode") %>%
  mutate(SiteName = factor(paste(SiteCode, "U", sep = "_")), Species = factor(Species)) %>% 
  group_by(Bioregion, Island, SiteName, Species) %>% 
  summarise_at(vars(Counts), funs(N = sum(., na.rm = T))) %>% 
  complete(Species, nesting(Bioregion, SiteName))
head(CountsUVC, n = 5)

#Checking species are correctly named as per FishData and attaching Family and Genus data
CountsUVC <- FishData %>% select(Family, Genus, ScientificName, ValidName, TrophicCat) %>% 
  rename("Species"="ScientificName") %>% 
  left_join(CountsUVC, ., by = "Species") %>% 
  select(-Species) %>% 
  rename("Species"="ValidName") %>% 
  mutate(Species = factor(Species)) %>% 
  ungroup()
```

### Baited Remote Underwater Video (BRUV) data
```{r}
#MaxN data
BRUV <- read.csv("Data/BRUVSMaxN.csv")
#Environmental data
BRUVEnviro <- read.csv("Data/BRUVEnviro.csv")
```

#### BRUV Data transformation
```{r, warning = F}
#Filtering out non-fish species from BRUV database, removing MaxN for different life stages/sex (MaxN column will conserve actual MaxN observed) and creating tibble table from BRUV data frame containing counts
BRUV <- BRUV %>% tbl_df() %>%
  filter(!SpeciesName %in% NonFish) %>% 
  filter(.,!duplicated(select(.,SiteName, Family, Genus, SpeciesName)))%>% 
  mutate(SpeciesName = factor(SpeciesName))

#Filtering out non-mangrove areas and creating a tibble table from BRUV environmental data
BRUVEnviro <- BRUVEnviro %>% filter(Habitat == "Mangrove") %>% tbl_df()

#Creating new tibble table containing counts data per site and per species
CountsBRUV <- BRUV %>% select(-c(Species, Stage, MaxN.by.stage)) %>% 
  right_join(., select(BRUVEnviro, SiteName, Bioregion, Island), by = "SiteName") %>%
  mutate(SiteName = factor(paste(SiteCode, Replicate, "B", sep = "_")), SpeciesName = factor(SpeciesName)) %>% 
  group_by(Bioregion, Island, SiteName, SpeciesName) %>% 
  summarise_at(vars(MaxN), funs(N = sum(., na.rm = T))) %>% 
  rename("Species"="SpeciesName") %>% 
  complete(Species, nesting(Bioregion, SiteName)) 
head(CountsUVC, n = 5)

#Checking species are correctly named as per FishData and attaching Family and Genus data
CountsBRUV <- FishData %>% select(Family, Genus, ScientificName, ValidName, TrophicCat) %>% 
  rename("Species"="ScientificName") %>% 
  left_join(CountsBRUV, ., by = "Species") %>% 
  select(-Species) %>% 
  rename("Species"="ValidName") %>% 
  mutate(Species = factor(Species)) %>% 
  ungroup()
```

### Fish counts statistics both methods
```{r, Fish communities}
#Creating dataset containing information for both methods
CountsALL <- rbind(CountsBRUV %>% mutate(Method = "BRUV"), 
                   CountsUVC %>% mutate(Method = "UVC"))
```

#### Families
```{r Families,warning=F}
BasicStats <- function(df, TaxLvl){
  if(TaxLvl == "Family"){
    df <- df %>% 
      filter(!grepl("^Silvery*", get(TaxLvl)))
  } else if(TaxLvl == "Species"){
    df <- df %>% 
      filter(!grepl("* sp$", get(TaxLvl)))}
  #Both methods - all data
  df %>% 
    distinct_at(vars(TaxLvl)) %>% 
    nrow() %>% 
    paste0(TaxLvl, ": ", .) %>% 
    print()
  #By Method and Bioregion
  df %>% 
    filter(!is.na(N)) %>% 
    group_by(Bioregion, Method) %>%
    distinct_at(vars(TaxLvl)) %>% 
    summarise_at(vars(TaxLvl), funs(N = n())) %>% 
    print()
  #By Method
  df %>% 
    filter(!is.na(N)) %>% 
    group_by(Method) %>%
    distinct_at(vars(TaxLvl)) %>% 
    summarise_at(vars(TaxLvl), funs(N = n())) %>% 
    print()
  #By bioregion
  df %>% 
    filter(!is.na(N)) %>% 
    group_by(Bioregion) %>%
    distinct_at(vars(TaxLvl)) %>% 
    summarise_at(vars(TaxLvl), funs(N = n())) %>% 
    print()}

#Unique to each method
UniqueMethod <- function(df, TaxLvl){
  if(TaxLvl == "Family"){
    df <- df %>% 
      filter(!grepl("^Silvery*", get(TaxLvl)))
  } else if(TaxLvl == "Species"){
    df <- df %>% 
      filter(!grepl("* sp$", get(TaxLvl)))}
  #UVC
  print("UVC")
  df %>% 
  filter(Method == "UVC" & !is.na(N)) %>% 
  distinct_at(vars(TaxLvl)) %>% 
  anti_join(distinct_at(df %>% filter(Method == "BRUV" & !is.na(N)) %>% 
                          distinct_at(vars(TaxLvl)), vars(TaxLvl))) %>% 
    print()
  #UVC per bioregion
  print("UVC per bioregion")
  df %>% 
    filter(Method == "UVC" & !is.na(N)) %>% 
    group_by(Bioregion) %>% 
    distinct_at(vars(TaxLvl)) %>% 
    anti_join(distinct_at(df %>% filter(Method == "BRUV" & !is.na(N)) %>% group_by(Bioregion) %>% 
                            distinct_at(vars(TaxLvl)), vars(TaxLvl))) %>% 
    print()
  #BRUV
  print("BRUV")
  df %>% 
    filter(Method == "BRUV" & !is.na(N)) %>% 
    distinct_at(vars(TaxLvl)) %>% 
    anti_join(distinct_at(df %>% filter(Method == "UVC" & !is.na(N)) %>% 
                            distinct_at(vars(TaxLvl)), vars(TaxLvl))) %>% 
    print()
  #BRUV per bioregion
  print("BRUV per bioregion")
  df %>% 
    filter(Method == "BRUV" & !is.na(N)) %>% 
    group_by(Bioregion) %>% 
    distinct_at(vars(TaxLvl)) %>% 
    anti_join(distinct_at(df %>% filter(Method == "UVC" & !is.na(N)) %>% group_by(Bioregion) %>% 
                            distinct_at(vars(TaxLvl)), vars(TaxLvl))) %>% 
  print()}

BasicStats(CountsALL, "Family")
UniqueMethod(CountsALL, "Family")
```

#### Genus
```{r Genus}
BasicStats(CountsALL, "Genus")
```

#### Species
```{r Species}
BasicStats(CountsALL, "Species")
UniqueMethod(CountsALL, "Species")
```

#### Individuals
```{r individuals}
#Individual Fish
CountsALL %>% summarise(Tot = sum(N, na.rm = T))

#Individuals per method and per bioregion
CountsALL %>% group_by(Method, Bioregion) %>% 
  summarise(Tot = sum(N, na.rm = T))
```

#### Number of fish classified as Silvery Fish
```{r Not Identified}
#Fish that could not be identified to species level (Silvery Fish)
CountsALL %>% filter(grepl("*silvery*", Species)) %>% summarise(Tot = sum(N, na.rm = T))
```

### Biodiversity measures
```{r, Biodiversity measures}
#Constructing matrix for multivariate analysis
FM_ALL <- CountsALL %>% 
  ungroup() %>% 
  select(SiteName, Species, N) %>% 
  pivot_wider(names_from = Species, values_from = N) %>% 
  remove_rownames() %>% 
  column_to_rownames(var = "SiteName") %>% as.matrix() %>% replace_na(., 0) %>% 
  .[order(rownames(.)),]
head(FM_ALL[,1:3])

#Creating database of biodiversity measures
BioAll <- tibble(SiteName = row.names(FM_ALL),
                 SpRich = specnumber(FM_ALL),
                 N = rowSums(FM_ALL),
                 Shannon = round(diversity(FM_ALL), 3),
                 Pielou = round(Shannon/log(N), 3)) %>% 
  left_join(select(CountsALL, Bioregion, SiteName, Method) %>% unique(), ., by = "SiteName")
```

#### Plotting mean abundance
```{r mean abundance}
#Number of individuals
p1 <- ggplot(BioAll, aes(Method, log(N+1)))+geom_boxplot()+
  labs(y = "Abundance \n (log(x+1))")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 11), 
        axis.text = element_text(family = "sans", size = 12))
p1
p2 <- ggplot(BioAll, aes(Bioregion, log(N+1)))+geom_boxplot()+facet_grid(.~Method)+
  labs(y = "Abundance \n (log(x+1))")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 11), 
        axis.text = element_text(family = "sans", size = 12))
p2
p3 <- ggplot(BioAll, aes(Bioregion, log(N+1)))+geom_boxplot()+
  labs(y = "")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 11), 
        axis.text = element_text(family = "sans", size = 12))
p3
MeanAbund <- ggarrange(ggarrange(p1, p3, ncol = 2, labels = c("A", "B"),
                                 font.label = list(size = 12)),
            p2, nrow = 2, labels = c("", "C"), font.label = list(size = 12))
MeanAbund
rm(p1, p2, p3)
ggsave("Figures/LogAbundance_AllPts.tiff", MeanAbund, device = "tiff", dpi = 500)

#Testing for differences between methods and bioregions - Univariate PERMANOVA
adonis(log(N+1) ~ Bioregion*Method, data = BioAll, method = "euc", permutations = 9999)
```

#### Plotting species richness
```{r species richness plot}
#Species richness
p1 <- ggplot(BioAll, aes(Method, SpRich))+geom_boxplot()+
  labs(y = "Species richness")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 11), 
        axis.text = element_text(family = "sans", size = 12))
p1
p2 <- ggplot(BioAll, aes(Bioregion, SpRich))+geom_boxplot()+
  facet_grid(~Method)+labs(y = "Species richness")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 11), 
        axis.text = element_text(family = "sans", size = 12))
p2
p3 <- ggplot(BioAll, aes(Bioregion, SpRich))+geom_boxplot()+
  labs(y = "")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 11), 
        axis.text = element_text(family = "sans", size = 12))
p3

SpRich <- ggarrange(ggarrange(p1, p3, ncol = 2, labels = c("A", "B"), 
                              font.label = list(size = 12), vjust = 1),
                    p2, nrow = 2, labels = c("", "C"), 
                    font.label = list(size = 12), vjust = 1)
SpRich
rm(p1, p2, p3)
ggsave("Figures/SpeciesRichness_AllPts.tiff", SpRich, device = "tiff",
       dpi = 500)

#Testing for differences between methods and bioregions - Univariate PERMANOVA
adonis(SpRich ~ Bioregion*Method, data = BioAll, method = "euc", permutations = 9999)
```

#### Plotting Shannon diversity index
```{r Shannon diversity}
#Species richness
p1 <- ggplot(BioAll, aes(Method, Shannon))+geom_boxplot()+
  labs(y = "Shannon index")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 11), 
        axis.text = element_text(family = "sans", size = 12))
p1
p2 <- ggplot(BioAll, aes(Bioregion, Shannon))+geom_boxplot()+
  facet_grid(~Method)+labs(y = "Shannon index")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 11), 
        axis.text = element_text(family = "sans", size = 12))
p2
p3 <- ggplot(BioAll, aes(Bioregion, Shannon))+geom_boxplot()+
  labs(y = "")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 11), 
        axis.text = element_text(family = "sans", size = 12))
p3
ShannonInd <- ggarrange(ggarrange(p1, p3, ncol = 2, labels = c("A", "B"), 
                              font.label = list(size = 12), vjust = 1.25),
                    p2, nrow = 2, labels = c("", "C"), 
                    font.label = list(size = 12), vjust = 1)
ShannonInd
rm(p1, p2, p3)
ggsave("Figures/ShannonIndex_AllPts.tiff", ShannonInd, device = "tiff", dpi = 500)

#Testing for differences between methods and bioregions - Univariate PERMANOVA
adonis(Shannon ~ Bioregion*Method, data = BioAll, method = "euc", permutations = 9999)
```

#### Plotting Pielou evenness index
```{r Pielou evenness}
#Species evenness
p1 <- ggplot(BioAll, aes(Method, Pielou))+geom_boxplot()+
  labs(y = "Pielou's evenness")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 11), 
        axis.text = element_text(family = "sans", size = 12))
p1
p2 <- ggplot(BioAll, aes(Bioregion, Pielou))+geom_boxplot()+
  facet_grid(~Method)+labs(y = "Pielou's evenness")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 11), 
        axis.text = element_text(family = "sans", size = 12))
p2
p3 <- ggplot(BioAll, aes(Bioregion, Pielou))+geom_boxplot()+
  labs(y = "")+theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 11), 
        axis.text = element_text(family = "sans", size = 12))
p3
Pielou <- ggarrange(ggarrange(p1, p3, ncol = 2, labels = c("A", "B"), 
                              font.label = list(size = 12), vjust = 1,
                              hjust = -0.3),
                    p2, nrow = 2, labels = c("", "C"), 
                    font.label = list(size = 12), vjust = 1)
Pielou
rm(p1, p2, p3)
ggsave("Figures/Pielou_AllPts.tiff", Pielou, device = "tiff", dpi = 500)

#Testing for differences between methods and bioregions - Univariate PERMANOVA
adonis(Pielou ~ Bioregion*Method, data = BioAll %>% drop_na(), method = "euc", permutations = 9999)
```

### Plotting fish community composition
```{r fish community by method}
#By method
Counts <- CountsALL %>%
  drop_na(N) %>% 
  select(Method, Bioregion, Family, N) %>% 
  group_by(Method) %>% 
  mutate(TotalAb = sum(N, na.rm = T), Family = as.character(Family)) %>% 
  group_by(Method, Family) %>% 
  summarise(Sum = sum(N, na.rm = T), 
            Mean = mean(N, na.rm = T),
            SE = plotrix::std.error(N, na.rm = T),
            TotalAb = mean(TotalAb, na.rm = T), 
            Prop = Sum/TotalAb*100) %>% 
  mutate(Family = replace(Family, Prop < 5, "Other Families")) %>% 
  group_by(Method, Family) %>% 
  summarise(Prop = sum(Prop, na.rm = T), N = n()) %>% 
  as_tibble() %>% 
  mutate(Family = factor(Family)) %>% 
  mutate(Family = fct_reorder(Family, N)) %>% 
  ungroup()
```

```{r graph fish community by method}
#Labels
annot_text <- Counts %>% select(-Prop) %>% 
  filter(grepl("Other Families", Family)) %>% 
  unite(Label, Family, N, sep = ": ")

#Graph
p1 <- Counts %>% 
  ggplot(aes(x = Method, y = Prop, fill = Family))+
  geom_bar(position = "stack", stat = "identity")+
  scale_fill_manual(values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c",
                               "#ff7f00", "#cab2d6", "#6a3d9a"))+
  coord_flip()+
  scale_x_discrete(limits = rev(levels(as.factor(Counts$Method))))+
  labs(x = "Methods", y = "")+
  theme_bw()+theme(axis.title = element_text(family = "sans", size = 12), 
                   axis.text.y = element_text(angle = 90, hjust = 0.5),
                   axis.text = element_text(family = "sans", size = 12),
                   legend.text = element_text(family = "sans", size = 12),
                   legend.title = element_text(family = "sans", size = 12),
                   legend.position = "none",
                   axis.ticks.length.x = unit(0.25, "cm"))+
  annotate(geom = "text", x = 2.5, y = 75, 
           label = annot_text %>% filter(grepl("BRUV", Method)) %>% 
             select(Label) %>% paste(.))+
  annotate(geom = "text", x = 1.5, y = 75, 
           label = annot_text %>% filter(grepl("UVC", Method)) %>% 
             select(Label) %>% paste(.))
p1
rm(Counts)
```

```{r fish community by method & bioregion}
##By method and bioregion
CountsBioM <- CountsALL %>% 
  drop_na(N) %>% 
  select(Method, Bioregion, Family, N) %>% 
  group_by(Method, Bioregion) %>% 
  mutate(TotalAb = sum(N, na.rm = T), Family = as.character(Family)) %>% 
  group_by(Method, Bioregion, Family) %>% 
  summarise(Sum = sum(N, na.rm = T), 
            Mean = mean(N, na.rm = T),
            SE = plotrix::std.error(N, na.rm = T),
            TotalAb = mean(TotalAb, na.rm = T), 
            Prop = Sum/TotalAb*100) %>% 
  mutate(Family = replace(Family, Prop < 5, "Other Families")) %>% 
  group_by(Method, Bioregion, Family) %>% 
  summarise(Prop = sum(Prop, na.rm = T), N = n()) %>% 
  as_tibble() %>% 
  mutate(Family = factor(Family)) %>% 
  mutate(Family = fct_reorder(Family, N)) %>% 
  ungroup()
```

```{r graph fish community by method & bioregion}
#Labels
annot_text2 <- CountsBioM %>% select(-Prop) %>% 
  filter(grepl("Other Families", Family)) %>% 
  unite(Label, Family, N, sep = ": ")

#Graph
p2 <- CountsBioM %>% 
  ggplot(aes(x = "", y = Prop, fill = Family))+
  geom_bar(position = "stack", stat = "identity")+
  scale_fill_manual(values = c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f",
                               "#ff7f00", "#cab2d6", "#6a3d9a"),
                    guide = guide_legend(nrow = 2))+
  facet_grid(Method~Bioregion)+coord_flip()+
  geom_text(size = 4, family = "sans", data = annot_text2, 
            mapping = aes(x = Inf, y = Inf, label = Label),
            inherit.aes = F,
            hjust = 1.1, vjust = 1.1)+
  labs(x = "", y = "")+
  theme_bw()+
  theme(axis.title = element_text(family = "sans", size = 12), 
                   axis.text.y = element_text(angle = 90, hjust = 0.5),
                   axis.text = element_text(family = "sans", size = 12),
                   legend.text = element_text(family = "sans", size = 12),
                   legend.title = element_text(family = "sans", size = 12),
                   axis.ticks.length.x = unit(0.25, "cm"))
p2

#Merging the two plots into one panel
p2leg <- get_legend(p2)
rm(CountsBio)
```

```{rr fish community by bioregion}
CountsBio <- CountsALL %>% 
  drop_na(N) %>% 
  select(Bioregion, Family, N) %>% 
  group_by(Bioregion) %>% 
  mutate(TotalAb = sum(N, na.rm = T), Family = as.character(Family)) %>% 
  group_by(Bioregion, Family) %>% 
  summarise(Sum = sum(N, na.rm = T), 
            Mean = mean(N, na.rm = T),
            SE = plotrix::std.error(N, na.rm = T),
            TotalAb = mean(TotalAb, na.rm = T), 
            Prop = Sum/TotalAb*100) %>% 
  mutate(Family = replace(Family, Prop < 5, "Other Families")) %>% 
  group_by(Bioregion, Family) %>% 
  summarise(Prop = sum(Prop, na.rm = T), N = n()) %>% 
  as_tibble() %>% 
  mutate(Family = factor(Family)) %>% 
  mutate(Family = fct_reorder(Family, N)) %>% 
  ungroup()

#Labels
annot_text3 <- CountsBio %>% select(-Prop) %>% 
  filter(grepl("Other Families", Family)) %>% 
  unite(Label, Family, N, sep = ": ")

p3 <- CountsBio %>% 
  ggplot(aes(x = Bioregion, y = Prop, fill = Family))+
  geom_bar(position = "stack", stat = "identity")+
  scale_fill_manual(values = c("#a6cee3", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", 
                               "#ff7f00", "#cab2d6", "#6a3d9a"),
                    guide = guide_legend(nrow = 3))+
  coord_flip()+scale_x_discrete(limits = rev(levels(as.factor(CountsBio$Bioregion))))+
  labs(x = "Bioregion", y = "% total abundance")+
  theme_bw()+theme(axis.title = element_text(family = "sans", size = 12), 
                   axis.text.y = element_text(angle = 90, hjust = 0.5),
                   axis.text = element_text(family = "sans", size = 12),
                   legend.text = element_text(family = "sans", size = 12),
                   legend.title = element_text(family = "sans", size = 12),
                   legend.position = "none",
                   axis.ticks.length.x = unit(0.25, "cm"))+
  annotate(geom = "text", x = 2.5, y = 87.5, 
           label = annot_text3 %>% filter(grepl("Western", Bioregion)) %>% 
             select(Label) %>% paste(.))+
  annotate(geom = "text", x = 1.5, y = 87.5, 
           label = annot_text3 %>% filter(grepl("CSE", Bioregion)) %>% 
             select(Label) %>% paste(.))
p3

#Merging the two plots into one panel
CommComp <- ggarrange(plot_grid(p2leg, plot_grid(p1, p2+theme(legend.position = "none"), 
                                     align = "hv", axis = "lb", labels = c("A", "B"), 
                                     hjust = -1.5, rel_widths = c(0.8, 1)), 
                    ncol = 1, rel_heights = c(0.3, 1, 0.9),
          p3, labels = c("", "", "C"), nrow = 3))
CommComp
ggsave("Figures/CommunityFamCompAllPts.tiff", CommComp, device = "tiff", dpi = 600)
rm(p1, p2, p3, annot_text, CountsBio, p2leg, annot_text, annot_text2, annot_text3)
```


### Comparing carnivores and herbivores between methods 
```{r carnivores and herbivores}
#Creating dataframe with summary of trophic data - Blank category appears for individuals not identified to species level
Troph <- CountsALL %>% 
  group_by(Method, SiteName) %>% 
  mutate(TotalAb = sum(N, na.rm = T)) %>% 
  group_by(Method, SiteName, TrophicCat) %>%
  mutate(TotTrop = sum(N, na.rm = T), 
         PropTrop = TotTrop / TotalAb) %>% 
  group_by(Method, Bioregion, SiteName, TrophicCat) %>% 
  summarise_at(vars(PropTrop), funs(mean(., na.rm = T))) 

#Summary and graph at a method level
p1 <- Troph %>% group_by(Method, TrophicCat) %>% 
  summarise(MeanTrop = mean(PropTrop, na.rm = T), 
            SE_Trop = plotrix::std.error(PropTrop, na.rm = T)) %>% 
  filter(!TrophicCat == "") %>% 
  ggplot(aes(TrophicCat, MeanTrop, fill = Method))+
  geom_bar(stat = "identity", position = position_dodge(), color = "black")+
  scale_fill_manual(values = c("#E1E1E1", "white"))+
  geom_errorbar(aes(ymin = MeanTrop, ymax = MeanTrop+SE_Trop), width = 0.2,
                position = position_dodge(.9))+
  theme_bw()+scale_y_continuous(expand = expand_scale(mult = c(0,0.2)))+
  labs(x = "", y = "")+
  theme(axis.title = element_text(family = "sans", size = 12), 
                   axis.text = element_text(family = "sans", size = 12),
        legend.position = "top")+
  annotate(geom = "text", x = 1:4, y = c(0.1, 1, 0.1, 0.375), label = "*", size = 10)
p1

#Summary and graph at a method and bioregion level
p2 <- Troph %>% group_by(Method, Bioregion, TrophicCat) %>%
  summarise(MeanTrop = mean(PropTrop, na.rm = T),
            SE_Trop = plotrix::std.error(PropTrop, na.rm = T)) %>%
  filter(!TrophicCat == "") %>%
  ggplot(aes(TrophicCat, MeanTrop, fill = Bioregion))+
  geom_bar(stat = "identity", color = "black", position = position_dodge())+
  scale_fill_manual(values = c("#808080", "#000000"))+
  geom_errorbar(aes(ymin = MeanTrop, ymax = MeanTrop+SE_Trop), width = 0.2,
                position = position_dodge(.9))+
  facet_wrap(~Method)+theme_bw()+
  labs(x = "", y = "")+
  theme(axis.title = element_text(family = "sans", size = 12),
                   axis.text = element_text(family = "sans", size = 12),
        legend.position = "top")
p2

#Summary and graph across bioregions
p3 <- Troph %>% group_by(Bioregion, TrophicCat) %>%
  summarise(MeanTrop = mean(PropTrop, na.rm = T),
            SE_Trop = plotrix::std.error(PropTrop, na.rm = T)) %>%
  filter(!TrophicCat == "") %>%
  ggplot(aes(TrophicCat, MeanTrop, fill = Bioregion))+
  geom_bar(stat = "identity", position = position_dodge(), color = "black")+
  scale_fill_manual(values = c("#808080", "#000000"))+
  geom_errorbar(aes(ymin = MeanTrop, ymax = MeanTrop+SE_Trop), width = 0.2,
                position = position_dodge(.9))+
  theme_bw()+scale_y_continuous(expand = expand_scale(mult = c(0,0.2)))+
  labs(x = "", y = "")+
  theme(axis.title = element_text(family = "sans", size = 12),
                   axis.text = element_text(family = "sans", size = 12),
        legend.position = "top")+
  annotate(geom = "text", x = 3, y = 0.125, label = "*", size = 10)
p3

TrophCat <- ggarrange(p1, ggarrange(p2, p3, labels = c("B", "C"), nrow = 2, common.legend = T),
                      labels = c("A", "", ""), nrow = 2, heights = c(1, 2))
TrophCat <- annotate_figure(TrophCat, left = text_grob("Mean relative abundance", rot = 90, hjust = 0.5, size = 12))
TrophCat
rm(p1, p2, p3)
ggsave("Figures/TrophicProportions.tiff", TrophCat, device = "tiff", dpi = 500)

#Testing for differences between methods and bioregions - Univariate PERMANOVA
#Carnivores
adonis(PropTrop ~ Bioregion*Method, data = Troph %>% filter(TrophicCat == "Carnivore"), 
       method = "euc", permutations = 9999, na.rm = T)
#Herbivores
adonis(PropTrop ~ Bioregion*Method, data = Troph %>% filter(TrophicCat == "Herbivore"), 
       method = "euc", permutations = 9999, na.rm = T)
#Apex
adonis(PropTrop ~ Bioregion*Method, data = Troph %>% filter(TrophicCat == "Apex"), 
       method = "euc", permutations = 9999, na.rm = T)

#Omnivores
adonis(PropTrop ~ Bioregion*Method, data = Troph %>% filter(TrophicCat == "Omnivore"), 
       method = "euc", permutations = 9999, na.rm = T)
rm(Troph)
```

### Comparing fish assemblages between methods and bioregions
```{r fish assemblages}
#Fish count data
#Comparing species composition between methods
FishComp <- FM_ALL %>% as.data.frame() %>%
  mutate(SiteName = rownames(FM_ALL)) %>% 
  left_join(select(BioAll, SiteName, Bioregion, Method), by = "SiteName") %>% 
  group_by(Method) %>% 
  summarise_if(is.numeric, mean) %>% 
  pivot_longer(-c(Method), names_to = "Species", values_to = "MeanProp") %>% 
  pivot_wider(names_from = Method, values_from = MeanProp) %>% 
  left_join(select(FishData, ValidName, TrophicCat) %>% distinct(), by = c("Species" = "ValidName")) %>%
  mutate(TrophicCat = as.character(TrophicCat)) %>% 
  mutate(TrophicCat = replace(TrophicCat, TrophicCat == "", "Unallocated")) %>% 
  ggplot(aes(x = BRUV, y = UVC))+geom_point(aes(shape = TrophicCat), size = 2)+
  geom_text_repel(aes(label = ifelse(BRUV > 10 | UVC > 10, Species, "")),
                  nudge_x = 1.25,
                  segment.size = 0.5,
                  size = 4)+
  scale_x_continuous(expand = expand_scale(mult = c(0.1,0.2)))+
  geom_abline(slope = 1, linetype = "dashed")+
  theme_bw()+
  labs(x = "", y = "")+
  theme(axis.title = element_text(family = "sans", size = 12), 
                   axis.text = element_text(family = "sans", size = 12),
        legend.text = element_text(family = "sans", size = 12),
        legend.title = element_text(family = "sans", size = 12, face = "bold"),
        legend.position = "top")+
  scale_shape_discrete(name = "Trophic Category")+
  guides(shape = guide_legend(title.position = "top", title.hjust = 0.5))
FishComp

#Comparing species composition across bioregions - Only showing names of herbivores responsible for at least 5% of
#total composition
FishCompBio <- FM_ALL %>% as.data.frame() %>%
  mutate(SiteName = rownames(FM_ALL)) %>% 
  left_join(select(BioAll, SiteName, Bioregion, Method), by = "SiteName") %>% 
  group_by(Method, Bioregion) %>% 
  summarise_if(is.numeric, mean) %>% 
  pivot_longer(-c(Method, Bioregion), names_to = "Species", values_to = "MeanProp") %>% 
  pivot_wider(names_from = Method, values_from = MeanProp) %>% 
  left_join(select(FishData, ValidName, TrophicCat) %>% distinct(), by = c("Species" = "ValidName")) %>%
  mutate(TrophicCat = as.character(TrophicCat)) %>% 
  mutate(TrophicCat = replace(TrophicCat, TrophicCat == "", "Unallocated")) %>% 
  ggplot(aes(x = BRUV, y = UVC))+geom_point(aes(shape = TrophicCat), size = 2)+
  geom_text_repel(aes(label = ifelse(TrophicCat == "Herbivore" & (BRUV > 2.5 | UVC > 2.5), Species, "")),
                  nudge_x = 1.25,
                  segment.size = 0.5,
                  size = 4)+
  scale_x_continuous(expand = expand_scale(mult = c(0.1,0.2)))+
  geom_abline(slope = 1, linetype = "dashed")+
  theme_bw()+facet_grid(Bioregion~.)+
  labs(x = "", y = "")+
  theme(axis.title = element_text(family = "sans", size = 12), 
                   axis.text = element_text(family = "sans", size = 12),
        legend.text = element_text(family = "sans", size = 12),
        legend.title = element_text(family = "sans", size = 12, face = "bold"),
        legend.position = "top")+
  scale_shape_discrete(name = "Trophic Category")+
  guides(shape = guide_legend(title.position = "top", title.hjust = 0.5))
FishCompBio

#Putting two graphs together
TrophicComp <- ggarrange(FishComp, FishCompBio, ncol = 2, common.legend = T, widths = c(1, 0.7))
TrophicComp <- annotate_figure(TrophicComp, left = text_grob("% UVC Abundance", vjust = 1.25,
                                                          rot = 90, hjust = 0.5, size = 12))
TrophicComp <- annotate_figure(TrophicComp, bottom = text_grob("% BRUV Abundance", hjust = 0.5, 
                                                               vjust = -0.5, size = 12))
TrophicComp
ggsave("Figures/MethodDetectionDifferences.tiff", TrophicComp, device = "tiff", dpi = 500)
rm(FishComp, FishCompBio)

#Simplfying the fish counts database: Calculation mean abundance values per site sampled
FM_Mean <- FM_ALL %>% as.data.frame() %>%
  mutate(SiteName = rownames(FM_ALL), 
         SiteCode = paste0(str_extract(SiteName, "[A-Z]{3,4}"), str_extract(SiteName, "[_][A-Z]{1}"))) %>%
  mutate(SiteCode = case_when(grepl("*_U$" , SiteCode) ~ SiteCode,
                              grepl("*_B$" , SiteCode) ~ SiteCode,
                              TRUE ~ paste0(SiteCode, "_B"))) %>% 
  group_by(SiteCode) %>% summarise_if(is.numeric, mean) %>% 
  remove_rownames() %>% column_to_rownames(var = "SiteCode") %>% 
  as.matrix()

#Creating new matrix with adjusted abundance values - Values as percentages
Norm_FM <- prop.table(FM_Mean, 1)*100

#Fourth root transformation applied to give more weight to rarer species
Trans_FM <- sqrt(sqrt(Norm_FM))

#Calculating Bray Curtis dissimilarity
BC_FM <- vegdist(Trans_FM)

#PCO
pco_FM <- wcmdscale(BC_FM, eig = T)
plot(pco_FM)

```

### Environmental variables
```{r Enviro variables}
#Environmental variables
#Pooling environmental data together - Getting mean values per site sampled for further analysis
MeanEnviro <- plyr::rbind.fill(BRUVEnviro %>% 
                                group_by(SiteCode) %>% 
                                summarise_if(is.numeric, mean) %>% 
                                select(-c(Depth, Replicate)) %>%
                                left_join(select(BRUVEnviro, SiteCode, Bioregion) %>% 
                                            distinct(), by = "SiteCode") %>% 
                                mutate(SiteCode = paste0(SiteCode, "_B"), Method = "BRUV"), 
                              UVCEnviro %>% 
                                mutate(SiteCode = str_extract(SiteCode, "[A-Z]{3,4}")) %>% 
                                group_by(SiteCode) %>% 
                                summarise_if(is.numeric, mean) %>%  
                                select(-c(Depth)) %>% 
                                left_join(., select(UVCEnviro, SiteCode, Bioregion) %>% 
                                            mutate(SiteCode = str_extract(SiteCode, "[A-Z]{3,4}")) %>% 
                                            distinct(), by = "SiteCode") %>% 
                                mutate(SiteCode = paste0(SiteCode, "_U"), Method = "UVC")) %>%
  arrange(SiteCode)


AllEnviro <- plyr::rbind.fill(BRUVEnviro %>% unite(SiteCode, SiteCode, Replicate) %>% 
                                mutate(SiteCode = paste0(SiteCode, "_B"), Method = "BRUV") %>% 
                                select(-c(SiteName, Time.of.day, Facing.mangroves., Location, Tide, 
                                          Substrate.type, Island, Depth, Habitat)) %>%
                                select(-starts_with("Yr")),
                              UVCEnviro %>% 
                                mutate(SiteCode = paste0(SiteCode, "_U"), Method = "UVC") %>% 
                                select(-c(Depth, SiteName, Habitat, Island)) %>% 
                                select(-starts_with("Yr"))) %>% 
  arrange(SiteCode) %>% write.csv("Outputs/RelativeFishAbundanceAllPts.csv")


#Visualising enviromental variables - Draftsman plots. To check if transformation is needed
MeanEnviro %>% select_if(is.numeric) %>% 
  mutate_at(vars(matches("area")), log) %>% GGally::ggpairs()

#The following variables variables were removed from further analysis to avoid multicollinearity:
#All variables removed had correlations >= 0.90
#Yearly Temperature and yearly chlorophyll as they showed high correlation with dry and wet season measurements
library(corrplot)
Env_Cor <- MeanEnviro %>% select_if(is.numeric) %>% select(-starts_with("Yr")) %>% 
  mutate_at(vars(matches("area")), log) %>% cor(use = "pairwise.complete.obs")
Env_PCor <- MeanEnviro %>% select_if(is.numeric) %>% select(-starts_with("Yr")) %>% 
  mutate_at(vars(matches("area")), log) %>% cor.mtest(use = "pairwise.complete.obs")
corrplot.mixed(Env_Cor, tl.pos = "lt", p.mat = Env_PCor$p, sig.level = 0.05)

#Normalising environmental data
Norm_Env <- MeanEnviro %>% select(-starts_with("Yr")) %>% 
  mutate_at(vars(matches("area")), log) %>% 
  mutate_if(is.numeric, list(~scale(.) %>% as.vector)) %>% 
  remove_rownames() %>% column_to_rownames(var = "SiteCode") %>% 
  select_if(is.numeric) %>% as.matrix() 

#Calculating Euclidean dissimilarity matrix
Euc_Env <- vegdist(Norm_Env, "euc", na.rm = T)
```

### Comparing fish lengths
#### Extracting data
```{r fish lengths}
#Uploading BRUVS lengths
B_Lengths <- read.csv("Data/BRUVSLengths.csv") %>% 
  tbl_df() %>% filter(!SpeciesName %in% NonFish) %>% 
  select(Length..mm., SiteCode, SpeciesName, Number) %>% 
  mutate(Length..mm. = Length..mm./10) %>% 
  rename("Species" = "SpeciesName", "Length_cm" = "Length..mm.") %>% 
  right_join(., select(BRUVEnviro, SiteCode, Bioregion) %>% distinct(), by = "SiteCode") %>% 
  filter(Length_cm > 0)
B_Lengths <- FishData %>% select(Family, Genus, ScientificName, ValidName, TrophicCat) %>% 
  rename("Species"="ScientificName") %>% 
  left_join(B_Lengths, ., by = "Species") %>% 
  select(-Species) %>% 
  rename("Species"="ValidName") %>% 
  mutate(Species = factor(Species)) %>% 
  ungroup()

#Creating function to extract length data for taxonomic groups of interest from BRUVS and UVC databases
ExtractLengths <- function(Sp){
  df <- rbind(UVC %>% filter(grepl(Sp, Species)) %>% 
  select(Bioregion, EstimatedSize, Counts, Species) %>% 
  rename("Length_cm" = "EstimatedSize") %>% 
  uncount(Counts) %>% 
  mutate(Method = "UVC"),
  B_Lengths %>% filter(grepl(Sp, Species)) %>% 
  select(Bioregion, Length_cm, Species) %>% 
  mutate(Method = "BRUV"))
  return(df)}

#Extracting length data 
Molfax <- ExtractLengths("Mycteroperca olfax")
Mugil <- ExtractLengths("Mugil")
Lutjanus <- ExtractLengths("Lutjanus")
```

#### KDE calculations
```{r}
#Mycteroperca olfax
Molfax_figM <- kde.compare(length = Molfax$Length_cm,
            group = Molfax$Method,
            align = "no",
            nboot = 500,
            xlab = "",
            ylab = "Probability Density",
            main = "Mycteroperca olfax")
Molfax_figM$graph <- Molfax_figM$graph + 
  geom_vline(xintercept = FishData$JuvLgth_m[FishData$ValidName == "Mycteroperca olfax"]*100, 
                      linetype = "dashed", color = "red")+
  annotate(geom = "text", x = c(57.5,57.5), y = c(0.065,0.075), 
           label = c(paste0("n = ", nrow(Molfax)), 
                     paste0("p = ", format(round(Molfax_figM$est$p, 2), nsmall = 2))), size = 4)
Molfax_figM$graph

Molfax_figBio <- kde.compare(length = Molfax$Length_cm,
            group = Molfax$Bioregion,
            align = "no",
            nboot = 500,
            xlab = "",
            ylab = "Probability Density",
            main = "")
Molfax_figBio$graph <- Molfax_figBio$graph + 
  geom_vline(xintercept = FishData$JuvLgth_m[FishData$ValidName == "Mycteroperca olfax"]*100, 
                      linetype = "dashed", color = "red")+
  annotate(geom = "text", x = c(57.5,57.5), y = c(0.065,0.075), 
           label = c(paste0("n = ", nrow(Molfax)), 
                     paste0("p = ", format(round(Molfax_figBio$est$p, 2), nsmall = 2))), size = 4)
Molfax_figBio$graph

#Mugil spp
Mugil_figM <- kde.compare(length = Mugil$Length_cm,
            group = Mugil$Method,
            align = "no",
            nboot = 500,
            xlab = "",
            ylab = "",
            main = "Mugil spp")
Mugil_figM$graph <- Mugil_figM$graph + 
  geom_vline(xintercept = FishData %>% filter(Genus == "Mugil") %>% 
               summarise_at(vars(JuvLgth_m), funs(max(., na.rm = T)*100)) %>% as.numeric(), 
                      linetype = "dashed", color = "red")+
  annotate(geom = "text", x = c(72.5,72.5), y = c(0.165,0.19), 
           label = c(paste0("n = ", nrow(Mugil)), 
                     paste0("p = ", format(round(Mugil_figM$est$p, 2), nsmall = 2))), size = 4)
Mugil_figM$graph

Mugil_figBio <- kde.compare(length = Mugil$Length_cm,
            group = Mugil$Bioregion,
            align = "no",
            nboot = 500,
            xlab = "Fork Length (cm)",
            ylab = "",
            main = "")
Mugil_figBio$graph <- Mugil_figBio$graph + 
  geom_vline(xintercept = FishData %>% filter(Genus == "Mugil") %>% 
               summarise_at(vars(JuvLgth_m), funs(max(., na.rm = T)*100)) %>% as.numeric(), 
                      linetype = "dashed", color = "red")+
  annotate(geom = "text", x = c(72.5,72.5), y = c(0.175,0.20), 
           label = c(paste0("n = ", nrow(Mugil)), 
                     paste0("p = ", format(round(Mugil_figBio$est$p, 2), nsmall = 2))), size = 4)
Mugil_figBio$graph

#Lutjanus spp
Lutjanus_figM <- kde.compare(length = Lutjanus$Length_cm,
            group = Lutjanus$Method,
            align = "no",
            nboot = 500,
            xlab = "",
            ylab = "",
            main = "Lutjanus spp")
Lutjanus_figM$graph <- Lutjanus_figM$graph + 
  geom_vline(xintercept = FishData %>% filter(Genus == "Lutjanus") %>% 
               summarise_at(vars(JuvLgth_m), funs(max(., na.rm = T)*100)) %>% as.numeric(), 
                      linetype = "dashed", color = "red")+
  annotate(geom = "text", x = c(85,85), y = c(0.0425,0.05), 
           label = c(paste0("n = ", nrow(Lutjanus)), 
                     paste0("p = ", format(round(Lutjanus_figM$est$p, 2), nsmall = 2))), size = 4)
Lutjanus_figM$graph

Lutjanus_figBio <- kde.compare(length = Lutjanus$Length_cm,
            group = Lutjanus$Bioregion,
            align = "no",
            nboot = 500,
            xlab = "",
            ylab = "",
            main = "")
Lutjanus_figBio$graph <- Lutjanus_figBio$graph + 
  geom_vline(xintercept = FishData %>% filter(Genus == "Lutjanus") %>% 
               summarise_at(vars(JuvLgth_m), funs(max(., na.rm = T)*100)) %>% as.numeric(), 
                      linetype = "dashed", color = "red")+
  annotate(geom = "text", x = c(85,85), y = c(0.15,0.175), 
           label = c(paste0("n = ", nrow(Lutjanus)), 
                     paste0("p = ", format(round(Lutjanus_figBio$est$p, 2), nsmall = 2))), size = 4)
Lutjanus_figBio$graph

#Putting graphs together
#Method
MetFig <- ggarrange(Molfax_figM$graph, Mugil_figM$graph, Lutjanus_figM$graph, ncol = 3, 
                    labels = c("A", "B", "C"), common.legend = T, hjust = -1.75)
MetFig <- annotate_figure(MetFig, left = text_grob("Method comparison", rot = 90, hjust = 0.6))
MetFig
#Bioregion
BioFig <- ggarrange(Molfax_figBio$graph, Mugil_figBio$graph, Lutjanus_figBio$graph, ncol = 3, 
                    legend = "bottom", common.legend = T)
BioFig <- annotate_figure(BioFig, left = text_grob("Bioregion comparison", rot = 90, hjust = 0.3))
BioFig
#Final
FinalFig <- ggarrange(MetFig, BioFig, nrow = 2)
FinalFig
ggsave("Figures/LengthsKDE.tiff", FinalFig, device = "tiff", dpi = 500)
rm(Molfax_figM, Mugil_figM, Lutjanus_figM, Molfax_figBio, Mugil_figBio, Lutjanus_figBio, MetFig, BioFig)

```


